{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mx-auto px-4 mt-6">

    <h2 class="text-2xl font-bold text-white mb-4">
        üìò Cr√©ation des mati√®res pour la classe {{ classe.nom }}
    </h2>

    <!-- Cr√©ation mati√®re -->
    <div class="mb-8 mt-8">
        <h3 class="text-xl font-semibold text-green-400 mb-2">Cr√©er une nouvelle mati√®re</h3>
        <form method="POST" class="flex flex-col sm:flex-row gap-2 items-center">
            {% csrf_token %}
            {{ matiere_form.nom|add_class:"text-red-600 bg-white w-full sm:w-auto rounded-md border-gray-300" }}
            <select name="prof" id="createProf" class="form-select w-full sm:w-auto rounded-md border-gray-300 text-red-600 bg-white">
                <option value="">-- Aucun professeur --</option>
                {% for user in users_actifs %}
                    <option value="{{ user.id }}">{{ user.get_full_name }} ({{ user.email }})</option>
                {% endfor %}
            </select>
            <button type="submit" name="create_matiere"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition duration-300">
                Ajouter
            </button>
        </form>
    </div>

    <!-- Liste des mati√®res -->
    <div class="mt-6">
        <h3 class="text-xl font-semibold text-green-400 mb-4">Liste des mati√®res de {{ classe.nom }}</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead>
                    <tr class="bg-gray-800">
                        <th class="px-4 py-2 text-left text-sm font-medium text-white">Nom</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-white">Professeur</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-white">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {% for matiere in classe.matieres.all %}
                    <tr>
                        <td class="px-4 py-2 text-red-600">{{ matiere.nom }}</td>
                        <td class="px-4 py-2 flex items-center gap-2">
                            {% if matiere.prof %}
                                {% if matiere.prof.profile_pic %}
                                    <img src="{{ matiere.prof.profile_pic.url }}" alt="Prof" class="w-8 h-8 rounded-full object-cover">
                                {% else %}
                                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Prof" class="w-8 h-8 rounded-full object-cover">
                                {% endif %}
                                <span class="text-white">{{ matiere.prof.get_full_name }}</span>
                            {% else %}
                                <span class="text-gray-400 italic">Aucun</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-2 flex gap-2">
                            <button type="button"
                                    onclick="openUpdateMatiereModal('{{ matiere.id }}', '{{ matiere.nom }}', '{{ matiere.prof.id|default:'' }}')"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded-md text-sm">
                                Modifier
                            </button>
                            <button type="button"
                                    onclick="confirmDeleteMatiere('{{ matiere.id }}', '{{ matiere.nom }}')"
                                    class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded-md text-sm">
                                Supprimer
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="px-4 py-2 text-gray-400 text-center">Aucune mati√®re cr√©√©e</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Modifier Mati√®re -->
<div id="updateMatiereModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-gray-900 rounded-xl p-6 w-96 relative">
        <button onclick="closeUpdateMatiereModal()" class="absolute top-2 right-2 text-gray-400 hover:text-white">&times;</button>
        <h2 class="text-lg font-semibold mb-4 text-indigo-400">Modifier mati√®re</h2>
        <form id="updateMatiereForm" method="POST">
            {% csrf_token %}
            <input type="hidden" name="matiere_id" id="updateMatiereId">
            <input type="text" name="nom" id="updateMatiereNom"
                   class="w-full mb-2 px-2 py-1 rounded-md border border-gray-300 text-red-600"
                   placeholder="Nom de la mati√®re">
            <select name="prof" id="updateProfMatiere" class="form-select w-full rounded-md border-gray-300 text-red-600 bg-white">
                <option value="">-- Aucun professeur --</option>
                {% for user in users_actifs %}
                    <option value="{{ user.id }}">{{ user.get_full_name }} ({{ user.email }})</option>
                {% endfor %}
            </select>
            <button type="submit" name="update_matiere"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md w-full mt-3">
                Sauvegarder
            </button>
        </form>
    </div>
</div>

<!-- Librairies -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // TomSelect avec fond blanc et texte rouge
    ["#createProf", "#updateProfMatiere"].forEach(selector => {
        new TomSelect(selector, {
            allowEmptyOption: true,
            render: {
                option: (data, escape) => `<div class='text-red-600 bg-white p-1 rounded-md hover:bg-gray-100'>${escape(data.text)}</div>`,
                item: (data, escape) => `<div class='text-red-600 bg-white p-1'>${escape(data.text)}</div>`
            },
            dropdownClass: "bg-white rounded-md shadow-lg",
        });
    });
});

// ---------- MODAL MODIFIER ----------
function openUpdateMatiereModal(id, nom, profId){
    document.getElementById('updateMatiereModal').classList.remove('hidden');
    document.getElementById('updateMatiereId').value = id;
    document.getElementById('updateMatiereNom').value = nom;
    document.getElementById('updateProfMatiere').tomselect.setValue(profId || '');
}
function closeUpdateMatiereModal(){
    document.getElementById('updateMatiereModal').classList.add('hidden');
}

// ---------- SUPPRESSION ----------
function confirmDeleteMatiere(matiereId, matiereNom){
    Swal.fire({
        title: '√ätes-vous s√ªr ?',
        text: `La mati√®re "${matiereNom}" sera supprim√©e !`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
    }).then((result)=>{
        if(result.isConfirmed){
            const form = document.createElement('form');
            form.method='POST';
            form.innerHTML=`{% csrf_token %}<input type="hidden" name="matiere_id" value="${matiereId}"><input type="hidden" name="delete_matiere" value="1">`;
            document.body.appendChild(form); form.submit();
        }
    });
}
</script>
{% endblock %}
